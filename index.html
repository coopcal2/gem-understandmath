<!-- 🔹 Chat Script -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const chatContainer = document.getElementById("chat-container");
    const promptForm = document.getElementById("prompt-form");
    const promptInput = document.getElementById("prompt-input");

    const chatHistory = [];

    function appendMessage(role, content) {
      const isUser = role === "user";
      const container = document.createElement("div");
      container.className = isUser ? "user-msg-container" : "ai-msg-container";

      const bubble = document.createElement("div");
      bubble.className =
        "message-card max-w-xl p-4 rounded-xl shadow-sm " +
        (isUser
          ? "bg-blue-100 text-blue-900"
          : "bg-white border border-slate-200");

      bubble.innerHTML = content.replace(/\n/g, "<br>");
      container.appendChild(bubble);
      chatContainer.appendChild(container);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      if (!isUser && window.MathJax) MathJax.typesetPromise([bubble]);
    }

    function showThinking() {
      const el = document.createElement("div");
      el.className = "ai-msg-container";
      el.id = "thinking";
      el.innerHTML =
        '<div class="message-card max-w-xl bg-white p-4 rounded-xl shadow-sm border border-slate-200">' +
        '<div class="flex items-center gap-3 text-slate-500">' +
        '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-slate-400"></div>' +
        "<span>The AI is thinking...</span>" +
        "</div></div>";
      chatContainer.appendChild(el);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      return el;
    }

    async function sendPrompt() {
      const text = promptInput.value.trim();
      if (!text) return;

      appendMessage("user", text);
      promptInput.value = "";
      chatHistory.push({ role: "user", content: text });

      const thinking = showThinking();

      try {
        // 🚀 Use Puter.js free AI
        const aiReply = await puter.ai.chat(
          "You are a helpful math tutor. Explain this problem clearly and step-by-step, with reasoning and structure:\n\n" +
            text
        );

        thinking.remove();
        appendMessage("assistant", aiReply);
        chatHistory.push({ role: "assistant", content: aiReply });
      } catch (error) {
        console.error("Puter error:", error);
        thinking.remove();
        appendMessage(
          "assistant",
          "⚠️ Sorry, there was an error connecting to the AI."
        );
      }
    }

    promptForm.addEventListener("submit", (e) => {
      e.preventDefault();
      sendPrompt();
    });
  });
</script>
